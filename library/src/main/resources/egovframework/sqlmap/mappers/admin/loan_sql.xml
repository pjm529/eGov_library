<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="Loan">

	<resultMap id="bookMap" type="BookVO">
		<id column="loan_no" 			property="loanNo" />
		<result column="user_id" 		property="userId" />
		<result column="user_email" 	property="userEmail" />
		<result column="book_title" 	property="bookTitle" />
		<result column="book_author" 	property="bookAuthor" />
		<result column="book_isbn" 		property="bookIsbn" />
		<result column="book_cover"	 	property="bookCover" />
		<result column="book_pubDate" 	property="bookPubDate" />
		<result column="book_publisher" property="bookPublisher" />
		<result column="loan_date" 		property="loanDate" />
		<result column="return_date" 	property="returnDate" />
		<result column="return_period" 	property="returnPeriod" />
	</resultMap>

	<!-- 대출 내역 조회 --> 
	<select id="loanHistory" parameterType="Criteria" resultMap="bookMap">
		<![CDATA[
			SELECT
				user_id, book_title, book_isbn, loan_date, return_date, return_period 
		  	FROM 
		  		loan_history
		  	WHERE 1=1 
		]]>
		  	<include refid="criteria"></include>
		<![CDATA[
		  	ORDER BY loan_date DESC
		  	LIMIT #{skip}, #{amount}
		]]>		  	
	</select>
	
	<!-- 총 대출 수 -->
	<select id="historyTotal" parameterType="Criteria" resultType="int">
		<![CDATA[
			SELECT
				count(*) 
		  	FROM 
		  		loan_history
		  	WHERE 1=1 
		]]>
			<include refid="criteria"></include>
	</select>
	
	<!-- 대출 중 내역 조회 --> 
	<select id="loanList" parameterType="Criteria" resultMap="bookMap">
		<![CDATA[
			SELECT
				user_id, book_title, book_isbn, loan_date, return_date, return_period 
		  	FROM 
		  		loan_history
		  	WHERE return_status = false 
		]]>
		  	<include refid="criteria"></include>
		<![CDATA[
		  	ORDER BY loan_date DESC
		  	LIMIT #{skip}, #{amount}
		]]>		  	
	</select>
	
	<!-- 대출 중 도서 수 -->
	<select id="loanTotal" parameterType="Criteria" resultType="int">
		<![CDATA[
			SELECT
				count(*) 
		  	FROM 
		  		loan_history
		  	WHERE return_status = false 
		]]>
			<include refid="criteria"></include>
	</select>
	
	<sql id="criteria">
        <if test="type != null">
		  	<if test="keyword != null">
		  		<if test="type == 'userId'">
		  			AND user_id LIKE CONCAT('%', #{keyword}, '%')
		  		</if>
		  		
		  		<if test="type == 'bookTitle'">
		  			AND book_title LIKE CONCAT('%', #{keyword}, '%')
		  		</if>
		  		
		  		<if test="type == 'bookIsbn'">
		  			AND book_isbn LIKE CONCAT('%', #{keyword}, '%')
		  		</if>
		  		
		  		<if test="type == 'loanDate'">
		  			AND loan_date LIKE CONCAT('%', #{keyword}, '%')
		  		</if> 
			</if>
		</if>
    </sql>
</mapper>
