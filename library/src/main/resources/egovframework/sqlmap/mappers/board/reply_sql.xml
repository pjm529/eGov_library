<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="Reply">

	<resultMap id="replyMap" type="ReplyVO">
		<id column="reply_no"				property="replyNo" />
		<result column="notice_no"			property="noticeNo" />
		<result column="reply_content"		property="replyContent" />
		<result column="writer_id"	 		property="writerId" />
		<result column="writer_name"	 	property="writerName" />
		<result column="reply_reg_date" 	property="replyRegDate" />
		<result column="reply_modify_date" 	property="replyModifyDate" />
		<result column="parent_no"	 		property="parentNo" />
		
		<collection property="replyList" resultMap="replyMap2"></collection>
	</resultMap>
	
	<resultMap id="replyMap2" type="ReplyVO">
		<id column="reply2No"				property="replyNo" />
		<result column="reply2Content"		property="replyContent" />
		<result column="writerId"	 	property="writerId" />
		<result column="writerName"	 	property="writerName" />
		<result column="reply2RegDate" 	property="replyRegDate" />
		<result column="reply2ModifyDate" 	property="replyModifyDate" />
	</resultMap>  

	<!-- 댓글 입력 -->
	<insert id="insertReply" parameterType="ReplyVO">
		<![CDATA[
			INSERT INTO
				reply (notice_no, reply_content, writer_id, writer_name)
			VALUES
				(#{noticeNo}, #{replyContent}, #{writerId}, #{writerName})				
		]]>
	</insert>
	
	<!-- 댓글 목록 -->
	<select id="replyList" parameterType="long" resultMap="replyMap">
		<![CDATA[
			SELECT
				r.*, 
				r2.reply_no AS reply2No, 
				r2.reply_content AS reply2Content,
				r2.writer_id AS writerId, 
				r2.writer_name AS writerName, 
				r2.reply_reg_date AS reply2RegDate, 
				r2.reply_modify_date AS reply2ModifyDate
			FROM
				reply r LEFT OUTER JOIN reply r2
				ON r.reply_no = r2.parent_no
			WHERE
				r.parent_no IS NULL AND r.notice_no = 1
			ORDER BY
				r.reply_reg_date, r2.reply_reg_date					
		]]>
	</select>
	
	<!-- 댓글 삭제 -->
	<delete id="deleteReply" parameterType="int">
		<![CDATA[
			DELETE
			FROM
				reply
			WHERE
				reply_no = #{replyNo}
		]]>
	</delete>
	
	<!-- 댓글 작성자 검색 -->
	<select id="searchWriter" parameterType="int" resultType="string">
		<![CDATA[
			SELECT
				writer_id
			FROM
				reply
			WHERE
				reply_no = #{replyNo}
		]]>
	</select>
	
	<!-- 댓글 수정 -->
	<update id="modifyReply" parameterType="ReplyVO">
		<![CDATA[
			UPDATE
				reply
			SET
				reply_content = #{replyContent},
				reply_modify_date = current_timestamp()
			WHERE
				reply_no = #{replyNo} AND
				writer_id = #{writerId}
		]]>
	</update>
	
	<!-- 대댓글 입력 -->
	<insert id="insertReply2" parameterType="ReplyVO">
		<![CDATA[
			INSERT INTO
				reply (notice_no, reply_content, writer_id, writer_name, parent_no)
			VALUES
				(#{noticeNo}, #{replyContent}, #{writerId}, #{writerName}, #{parentNo})				
		]]>
	</insert>
</mapper>
