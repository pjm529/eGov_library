<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="Book">

	<!-- 대출 중인 해당 도서 수 카운트 -->
	<select id="count" parameterType="string" resultType="int"> 
		<![CDATA[
			SELECT 
				count(*)
			FROM 
				loan_history  
			WHERE 
				book_isbn = #{bookIsbn} AND return_status = false
		]]>
	</select>
	
	<!-- 대출자 상태 체크 -->
	<select id="statusCheck" parameterType="string" resultType="int">
		<![CDATA[
			SELECT
				count(*)
			FROM 
				member 
			WHERE
				user_id = #{userId} AND 
				user_overdue_date = 0 AND 
				user_book_count < (SELECT 
								   		user_able_loan 
								   FROM
								   		member 
								   WHERE
								   		user_id = #{userId})
		 ]]>
	</select>
	
	<!-- 회원이 대출 중인 도서인지 체크 -->
	<select id="loanCheck" parameterType="hashMap" resultType="int">
		<![CDATA[
			SELECT
				count(*)
			FROM
				loan_history
			WHERE 
				user_id = #{userId} AND book_isbn = #{bookIsbn} AND return_status = false
		]]> 
	</select>
	
	<!-- 도서 대출 -->
	<insert id="loan" parameterType="BookVO">
		<![CDATA[
			INSERT INTO loan_history
				(user_id, user_email, book_title, book_author, book_isbn, 
					book_cover, book_pubDate, book_publisher, return_period)
			VALUES
				(#{userId}, #{userEmail}, #{bookTitle}, #{bookAuthor}, #{bookIsbn}, #{bookCover}, 
				#{bookPubDate}, #{bookPublisher}, adddate(current_timestamp, 14))
		]]> 		
	</insert>
	
	<!-- 대출자 대출 중 도서 수 증가 -->
	<update id="increaseCount">
		<![CDATA[
			UPDATE member
			SET 
				user_book_count = user_book_count + 1
			WHERE
				user_id = #{userId};
		]]> 
	</update>
</mapper>
